<!DOCTYPE html>
<html lang="en" xmlns:th="http://wwww.thymeleaf.org">
<th:block th:replace="~{/layout/layout1 :: setContent(~{this::content} )}">
	<th:block th:fragment="content">
<link th:href="@{/css/register.css}" rel="stylesheet" />

	<!-- 게시글 등록 -->
	<form th:action="@{/travelrecord/register}" th:method="post">
		<div class="form-group">
			<h3 style="margin-bottom: 20px;">여행기록 작성</h3>
			<label class="labels">작성자 : </label> <input class="form-control"
				type="text" name="writerName">
		</div>
		<div class="form-group">
			<label class="labels">작성자 이메일 : </label> <input class="form-control"
				type="email" name="writerEmail">
		</div>
		<div class="form-group">
			<label class="labels">나라 : </label> <input class="form-control"
				type="text" name="title" placeholder="첫 글자는 대문자인 영어로만 작성해주세요">
		</div>
		<div class="form-group">
			<label class="labels">여행기간 : </label> <input class="form-control"
				type="text" name="travelDate"
				placeholder="0000-00-00~0000-00-00으로 입력해주세요">
		</div>
		<div class="form-group">
			<label class="labels">내용 : </label>
			<textarea class="form-control" name="content" rows="2" cols="50"></textarea>
		</div>
		
		<!-- 첨부파일  -->
		<div class="form-group">
			<input name="uploadImages" type="file" multiple>
			<label class="images" data-browse="Browse"></label>
			<button class="uploadBtn">등록</button>
			
			
			<div class="uploadImageResult">
		
			</div>
		</div>
		
		<script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
		
		<script>
		$(document).ready(function(e){
			var regex = new RegExp("(.*?\.(exe|sh|zip|alz|tiff)$)");
			var maxSize = 10485760;//10mb
			
			function checkExtension(imageName, fileSize) {
				if(fileSize >= maxSize) {
					alert("파일 사이즈 초과");
					return false;
				}
				
				if(regex.test(imageName)) {
					alert("해당 종류의 파일은 업로드 할 수 없습니다.");
					return false;
				}
				return true;
			}
			
			$(".uploadImages").on("change", function() {
				var imageName = $(this).val().split("\\").pop();
				$(this).siblings(".images").addClass("selected").html(imageName);
				
				var formData = new FormData();
				var inputFile = $("input[type]='file'"]);
				var files = inputFile[0].files;
				var appended = false;
				
				for(var i=0; i<files.length; i++) {
					if(!checkExtension(files[i].name, files[i], size)) {
						return false;
					}
					console.log(files[i]);
					formData.append("uploadImages", files[i]);
					appended = true;
				}
				 if(!appended) {return;}
				 
				 for(var value of formData.values()) {
					 console.log(value);
				 }
				 
				 $.ajax({
						url: '/uploadImage',
						type: 'POST',
						processData: false,
						contentType: false,
						data: formData,
						dataType: 'json',
						success: function(result){
							showUploadImaages(result);
						},
						error: function(jqXHR, textStatus, errorThrown) {
							console.log(textStatus);
						}
					});
			});
			
		});
			
				
				
				
			
			function showUploadImages(arr) {
				console.log(arr);
				
				var divArea = $(".uploadImageResult");
				
				var str ="";
				
				for(var i=0; i<arr.length; i++) {
					str += "<div>";
					str += "<img src='/display?imageName="arr[i].thumbnailURL+"'>";
					str += "<button class='removeBtn' data-name='"arr[i].imageURL+"'>삭제</button>";
					str += "</div>";
				}
				divArea.append(str);
			}
			
			$(".uploadImageResult").click(function(){
				var target = $(this);
				var imageName = target.data("name");
				var targetDiv = $(this).closest("div");
				
				console.log(imageName);
				
				$.post('/removeImage', {imageName : imageName}, function(result){
					console.log(result);
					
					if(result == true){
						targetDiv.remove();
					}
				})
			});
		</script>
		
		<!-- 버튼 -->
		<div class="form-group">
			<button class="btn" type="submit" id="registerBtn"style="background-color: yellow;">등록</button>
			<button class="btn" type="reset" id="resetBtn">초기화</button>
			<!-- <a th:href="@{/travelrecord/list(tnum=${dto.tnum}, page=${requestDTO.page})}">
            	<button class="btn" data-oper="listPost" id='listBtn'>목록</button>
            </a> -->
		</div>
	</form>
     
     <script th:inline="javascript">
     	var registerForm = $("form");
     	
     	$("#registerBtn").click(function() {
     		if(!confirm("등록하시겠습니까?")) {
     			return;
     		}
     	});
     </script>
	</th:block>
</th:block>